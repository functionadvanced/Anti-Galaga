</!DOCTYPE html>
<html>
<head>
	<title>Anti Galaga</title>
	<script src='https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js'></script>
	<script src='https://apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js'></script>
	<link rel='stylesheet' href='https://apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.css'/>
	<link href="https://fonts.googleapis.com/css?family=Overpass+Mono" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Oswald" rel="stylesheet">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
	<style type="text/css">
		body {
			background-color: black;
			text-align: center;
		}
		h1 {
			color: white;
		}
		#mCanvas {
			border: 2px solid white;
			margin: auto;
			display: block;
		}
	</style>
</head>
<body style="height: 100%;width: 100%;margin: 0;padding: 0;">
<h1>Anti-Galaga</h1>
<canvas id="mCanvas" width="300" height="400"></canvas>
<canvas id="mCanvas2" width="300" height="100"></canvas>
<button onclick="Attack(0)">A</button>
<button onclick="Attack(1)">B</button>
<button onclick="Attack(2)">C</button>
<button onclick="Attack(3)">D</button>
<script type="text/javascript">
	var c=$("#mCanvas")[0];
	var cxt=c.getContext("2d");
	var c2=$("#mCanvas2")[0];
	var cxt2=c2.getContext("2d");
	var img = new Image;
	var invulnerableFlag = false;
	function turnOnInv() {
		invulnerableFlag = true;
		setTimeout("turnOffInv()", 2000); // 2 sec invulnerable
	}
	function turnOffInv() {
		invulnerableFlag = false;
	}
	img.src = "5355fd144740b.png";
	img.onload = function() {
		setInterval("draw()",5);
	}
	var kindImg = [
		[3453, 4074, 0, 637], // fx, tx, fy, ty
		[450, 500, 0, 637], // bullet of ship
		[450, 500, 0, 637], // bullet of monster
		[223, 974, 0, 637],// moster 1
		[1274, 2025, 0, 637],
		[2325, 3176, 0, 637],
		[223, 1100, 1000, 1637],
		[1450, 2300, 1000, 1637],
		[2700, 4100, 900, 1637],
		[223, 1100, 2037, 2237],
		[1530, 2300, 2057, 2237] // monster 8
	];
	var elems = [];
	reborn();
	//addElem(2, 100, 390, 5, 5, 0, 0);
	function reborn() {
		console.log("reborn");
		turnOnInv();
		addElem(0, 137.5, 375, 25, 25, 15, 0);
	}
	function draw() {
		//draw
		cxt2.fillStyle = "#FF0000";
		cxt2.fillRect(0, 0, 50, 50);
		cxt.clearRect(0, 0, c.clientWidth, c.clientHeight);
		for (i in elems) {
			while (elems[i].delFlag){
				// if (elems[i].kind == 0)
				// 	setTimeout("reborn()", 500);
				if (elems[i].kind == 0)
					setTimeout("reborn()", 1000);
				delElem(i);
				if (i >= elems.length)
					break;
			}
			if (i >= elems.length)
				break;
			showElem(i);
			elems[i].AI();
			elems[i].move();
			if (elems[i].kind != 1 && elems[i].kind != 2) // if not bullet
				elems[i].shoot();
		}
		// collision detection
		for (i in elems){
			for (j in elems) {
				if (i == j)
					continue;
				if (elems[i].kind > 2 && elems[j].kind > 2)
					continue;
				if ((elems[i].kind == 1 && elems[j].kind <= 2) || (elems[j].kind == 1 && elems[i].kind <= 2))
					continue;
				if ((elems[i].kind == 2 && elems[j].kind != 0) || (elems[j].kind == 2 && elems[i].kind != 0))
					continue;
				if ((elems[i].pos.x >= elems[j].pos.x && elems[i].pos.x <= elems[j].pos.x+elems[j].pos.width)
					|| (elems[i].pos.x+elems[i].pos.width >= elems[j].pos.x && elems[i].pos.x+elems[i].pos.width <= elems[j].pos.x+elems[j].pos.width)){
					if ((elems[i].pos.y >= elems[j].pos.y && elems[i].pos.y <= elems[j].pos.y+elems[j].pos.height)
					|| (elems[i].pos.y+elems[i].pos.height >= elems[j].pos.y && elems[i].pos.y+elems[i].pos.height <= elems[j].pos.y+elems[j].pos.height)){
						//console.log("collision");
						// console.log(elems[i].kind+"  "+elems[j].kind);
						// console.log(elems[i]);
						// console.log(elems[j]);
						elems[i].delFlag = true;
						elems[j].delFlag = true;
						if (invulnerableFlag) {
							if (elems[i].kind == 0)
								elems[i].delFlag = false;
							if (elems[j].kind == 0)
								elems[j].delFlag = false;
						}
					}
				}
			}
		}
	}
	function showElem(_which) {
		cxt.drawImage(img, 
			kindImg[elems[_which].kind][0],
			kindImg[elems[_which].kind][2], 
			kindImg[elems[_which].kind][1]-kindImg[elems[_which].kind][0],
			kindImg[elems[_which].kind][1]-kindImg[elems[_which].kind][0],
			elems[_which].pos.x, elems[_which].pos.y, elems[_which].pos.width, elems[_which].pos.height);
	}
	function addElem(_kind, _x, _y, _width, _height, _dx, _dy) {
		temp = {
			"kind": _kind,
			"pos": {
				x: _x,
				y: _y,
				width: _width,
				height: _height
			},
			"speed": {
				dx: _dx,
				dy: _dy
			},
			"delFlag": false,
			"shootInterval": 150,
			AI: function(){
				if (this.kind == 0) {// if this is the ship
					if (invulnerableFlag) {
						this.speed.dx = -this.speed.dx;
						return;
					}
					checkFx = this.pos.x+40*this.speed.dx/Math.abs(this.speed.dx);
					checkFy = this.pos.y-60;
					checkTx = this.pos.x+this.pos.width/2+10*this.speed.dx/Math.abs(this.speed.dx);
					checkTy = this.pos.y+this.pos.height;

					safeFlag = true;
					for (ii in elems) {
						if (elems[ii].kind == 0 || elems[ii].kind == 1)
							continue;
						temp1 = elems[ii].pos.x+elems[ii].pos.width/2 - checkFx;
						temp2 = elems[ii].pos.x+elems[ii].pos.width/2 - checkTx;
						temp3 = elems[ii].pos.y+elems[ii].pos.height/2 - checkFy;
						temp4 = elems[ii].pos.y+elems[ii].pos.height/2 - checkTy;
						//console.log("1: "+temp1+" 2: "+temp2+" 3: "+temp3+" 4: "+temp4);
						if (temp1 * temp2 < 0){
							if (temp3 * temp4 < 0){
								safeFlag = false;
								break;
							}
						}
					}
					if (this.pos.x <= 0 || this.pos.x+this.pos.width >= c.clientWidth){
						safeFlag = false;
					}
					if (safeFlag){
						//this.speed.dx = -Math.abs(this.speed.dx);
						return;
					}
					checkFx = this.pos.x-40*this.speed.dx/Math.abs(this.speed.dx);
					checkFy = this.pos.y-60;
					checkTx = this.pos.x+this.pos.width/2-10*this.speed.dx/Math.abs(this.speed.dx);
					checkTy = this.pos.y+this.pos.height;
					safeFlag = true;
					for (ii in elems) {
						if (elems[ii].kind == 0 || elems[ii].kind == 1)
							continue;
						temp1 = elems[ii].pos.x+elems[ii].pos.width/2 - checkFx;
						temp2 = elems[ii].pos.x+elems[ii].pos.width/2 - checkTx;
						temp3 = elems[ii].pos.y+elems[ii].pos.height/2 - checkFy;
						temp4 = elems[ii].pos.y+elems[ii].pos.height/2 - checkTy;
						if (temp1 * temp2 < 0){
							if (temp3 * temp4 < 0){
								safeFlag = false;
								break;
							}
						}
					}
					//console.log(safeFlag);
					if (safeFlag){
						this.speed.dx = -this.speed.dx;
						return;
					}
				}
				if (this.kind > 2) { // if this is a monster

				}
			},
			move: function(){
				this.pos.x += this.speed.dx / 10;
				this.pos.y += this.speed.dy / 10;
				switch(this.kind) {
					case 0:
						if (this.pos.x < 0)
							this.pos.x = 0;
						if (this.pos.x > c.clientWidth-this.pos.width)
							this.pos.x = c.clientWidth-this.pos.width;
						break;
					case 1: // bullet
						if (this.pos.x < 0 || (c.clientWidth-this.pos.width-this.pos.x) < 0
							|| this.pos.y < 0 || (c.clientHeight-this.pos.height-this.pos.y) < 0)
							this.delFlag = true;
						break;
					case 2: // bullet
						if (this.pos.x < 0 || (c.clientWidth-this.pos.width-this.pos.x) < 0
							|| this.pos.y < 0 || (c.clientHeight-this.pos.height-this.pos.y) < 0)
							this.delFlag = true;
						break;
					default: // monster
						if (this.pos.x < 0 || (c.clientWidth-this.pos.width-this.pos.x) < 0)
							this.speed.dx = -this.speed.dx;
						if (this.pos.y < 0 || (c.clientHeight-this.pos.height-this.pos.y) < 0)
							this.speed.dy = -this.speed.dy;

				}
			},
			shoot: function(){
				this.shootInterval--;
				if (this.kind == 0)
					this.shootInterval -= 3;
				if (this.shootInterval < 0){
					if (this.kind == 0){
						addElem(1, this.pos.x+this.pos.width/2-2.5, this.pos.y+this.pos.height/2, 5, 5, this.speed.dx, this.speed.dy-15);
						addElem(1, this.pos.x+this.pos.width/2-2.5, this.pos.y+this.pos.height/2, 5, 5, this.speed.dx+15, this.speed.dy-15);
						addElem(1, this.pos.x+this.pos.width/2-2.5, this.pos.y+this.pos.height/2, 5, 5, this.speed.dx-15, this.speed.dy-15);
						addElem(1, this.pos.x+this.pos.width/2-2.5, this.pos.y+this.pos.height/2, 5, 5, this.speed.dx+5, this.speed.dy-15);
						addElem(1, this.pos.x+this.pos.width/2-2.5, this.pos.y+this.pos.height/2, 5, 5, this.speed.dx-5, this.speed.dy-15);

					}else{
						addElem(2, this.pos.x+this.pos.width/2-2.5, this.pos.y+this.pos.height/2, 5, 5, this.speed.dx, this.speed.dy+15);
					}
					
					this.shootInterval = 150;
				}
			}
		};
		elems.push(temp);
	}
	function delElem(_which) {
		elems.splice(_which, 1);
	}

	function Attack(_mode) {
		switch(_mode){
			case 0:	addElem(3, 100, 0, 25, 25, 1, 5); break;
			case 1: 
				addElem(4, 100, 100, 25, 25, 5, 0); 
				addElem(4, 100, 100, 25, 25, -5, 0);

				break;
			case 2: 
				addElem(5, 0, 0, 25, 25, 5, 2);
				addElem(5, 200, 0, 25, 25, -5, 2);
				break;
			case 3: addElem(6, 200, 50, 25, 25, -5, 1); break;

		}
	}
</script>
</body>
</html>
