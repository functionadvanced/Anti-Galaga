</!DOCTYPE html>
<html>
<head>
	<title>Anti Galaga</title>
	<script src='https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js'></script>
	<script src='https://apps.bdimg.com/libs/bootstrap/3.3.4/js/bootstrap.min.js'></script>
	<link rel='stylesheet' href='https://apps.bdimg.com/libs/bootstrap/3.3.4/css/bootstrap.css'/>
	<link href="https://fonts.googleapis.com/css?family=Overpass+Mono" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Oswald" rel="stylesheet">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
	<style type="text/css">
		body {
			background-color: black;
			text-align: center;
		}
		h1 {
			color: white;
		}
		#mCanvas {
			border: 2px solid white;
			margin: auto;
			display: block;
		}
	</style>
</head>
<body style="height: 100%;width: 100%;margin: 0;padding: 0;">
<h1>Anti-Galaga</h1>
<canvas id="mCanvas" width="300" height="450"></canvas>
<script type="text/javascript">
	var c=$("#mCanvas")[0];
	var cxt=c.getContext("2d");
	var img = new Image;
	img.src = "5355fd144740b.png";
	img.onload = function() {
		setInterval("draw()",200);
	}
	var kindImg = [
		[3453, 4074, 0, 637], // fx, tx, fy, ty
		[450, 500, 0, 637], // bullet of ship
		[450, 500, 0, 637], // bullet of monster
		[223, 974, 0, 637],// moster 1
		[1274, 2025, 0, 637],
		[2325, 3176, 0, 637],
		[223, 1100, 1000, 1637],
		[1450, 2300, 1000, 1637],
		[2700, 4100, 900, 1637],
		[223, 1100, 2037, 2237],
		[1530, 2300, 2057, 2237] // monster 8
	];
	var elems = [];
	addElem(0, 137.5, 420, 25, 25, 5, 5);
	addElem(3, 0, 0, 25, 25, 5, 5);
	function draw() {
		//draw
		cxt.clearRect(0, 0, c.clientWidth, c.clientHeight);
		for (i in elems) {
			while (elems[i].delFlag){
				delElem(i);
				if (i >= elems.length)
					break;
			}
			if (i >= elems.length)
				break;
			showElem(i);
			elems[i].AI();
			elems[i].move();
			if (elems[i].kind != 1 && elems[i].kind != 2) // if not bullet
				elems[i].shoot();
		}
		// collision detection
		for (i in elems){
			for (j in elems) {
				if (i == j)
					continue;
				if ((elems[i].kind == 1 && elems[j].kind <= 2) || (elems[j].kind == 1 && elems[i].kind <= 2))
					continue;
				if ((elems[i].kind == 2 && elems[j].kind != 0) || (elems[j].kind == 2 && elems[i].kind != 0))
					continue;
				if ((elems[i].pos.x >= elems[j].pos.x && elems[i].pos.x <= elems[j].pos.x+elems[j].pos.width)
					|| (elems[i].pos.x+elems[i].pos.width >= elems[j].pos.x && elems[i].pos.x+elems[i].pos.width <= elems[j].pos.x+elems[j].pos.width)){
					if ((elems[i].pos.y >= elems[j].pos.y && elems[i].pos.y <= elems[j].pos.y+elems[j].pos.height)
					|| (elems[i].pos.y+elems[i].pos.height >= elems[j].pos.y && elems[i].pos.y+elems[i].pos.height <= elems[j].pos.x+elems[j].pos.height)){
						//console.log("collision");
						console.log(elems[i].kind+"  "+elems[j].kind);
						elems[i].delFlag = true;
						elems[j].delFlag = true;
					}
				}
			}
		}
	}
	function showElem(_which) {
		cxt.drawImage(img, 
			kindImg[elems[_which].kind][0],
			kindImg[elems[_which].kind][2], 
			kindImg[elems[_which].kind][1]-kindImg[elems[_which].kind][0],
			kindImg[elems[_which].kind][1]-kindImg[elems[_which].kind][0],
			elems[_which].pos.x, elems[_which].pos.y, elems[_which].pos.width, elems[_which].pos.height);
	}
	function addElem(_kind, _x, _y, _width, _height, _dx, _dy) {
		temp = {
			"kind": _kind,
			"pos": {
				x: _x,
				y: _y,
				width: _width,
				height: _height
			},
			"speed": {
				dx: _dx,
				dy: _dy
			},
			"delFlag": false,
			"shootInterval": 10,
			AI: function(){
				if (this.kind == 0) {// if this is the ship
					checkFx = this.pos.x-20;
					checkFy = this.pos.y-20;
					checkTx = this.pos.x+this.pos.width;
					checkTy = this.pos.y+this.pos.height;
					safeFlag = true;
					for (ii in elems) {
						if (elems[ii].kind == 0 || elems[ii].kind == 1)
							continue;
						if ((elems[ii].pos.x > checkFx && elems[ii].pos.x < checkTx)
							||(elems[ii].pos.x+elems[ii].pos.width > checkFx && elems[ii].pos.x+elems[ii].pos.width < checkTx)){
							if ((elems[ii].pos.y > checkFy && elems[ii].pos.y < checkTy)
								||(elems[ii].pos.y+elems[ii].pos.height > checkFy && elems[ii].pos.y+elems[ii].pos.height < checkTy)){
								safeFlag = false;
								break;
							}
						}
					}
					if (safeFlag){
						this.speed.dx = -Math.abs(this.speed.dx);
						return;
					}
					checkFx = this.pos.x+20;
					checkFy = this.pos.y-20;
					checkTx = this.pos.x+this.pos.width;
					checkTy = this.pos.y+this.pos.height;
					safeFlag = true;
					for (ii in elems) {
						if (elems[ii].kind == 0 || elems[ii].kind == 1)
							continue;
						if ((elems[ii].pos.x > checkFx && elems[ii].pos.x < checkTx)
							||(elems[ii].pos.x+elems[ii].pos.width > checkFx && elems[ii].pos.x+elems[ii].pos.width < checkTx)){
							if ((elems[ii].pos.y > checkFy && elems[ii].pos.y < checkTy)
								||(elems[ii].pos.y+elems[ii].pos.height > checkFy && elems[ii].pos.y+elems[ii].pos.height < checkTy)){
								safeFlag = false;
								break;
							}
						}
					}
					if (safeFlag){
						this.speed.dx = Math.abs(this.speed.dx);
						return;
					}
				}
				if (this.kind > 2) { // if this is a monster

				}
			},
			move: function(){

				this.pos.x += this.speed.dx;
				this.pos.y += this.speed.dy;
				// if (this.kind == 0){
				// 	console.log("speed: "+this.speed.dx);
				// 	console.log("x: "+this.pos.x);
				// }
				switch(this.kind) {
					// case 0: // ship
					// 	if (this.pos.x < 0 || (c.clientWidth-this.pos.width-this.pos.x) < 0)
					// 		this.speed.dx = -this.speed.dx;
					// 	if (this.pos.y < 0 || (c.clientHeight-this.pos.height-this.pos.y) < 0)
					// 		this.speed.dy = -this.speed.dy;
					// 	break;
					case 1: // bullet
						if (this.pos.x < 0 || (c.clientWidth-this.pos.width-this.pos.x) < 0
							|| this.pos.y < 0 || (c.clientHeight-this.pos.height-this.pos.y) < 0)
							this.delFlag = true;
						break;
					case 2: // bullet
						if (this.pos.x < 0 || (c.clientWidth-this.pos.width-this.pos.x) < 0
							|| this.pos.y < 0 || (c.clientHeight-this.pos.height-this.pos.y) < 0)
							this.delFlag = true;
						break;
					default: // monster
						if (this.pos.x < 0 || (c.clientWidth-this.pos.width-this.pos.x) < 0)
							this.speed.dx = -this.speed.dx;
						if (this.pos.y < 0 || (c.clientHeight-this.pos.height-this.pos.y) < 0)
							this.speed.dy = -this.speed.dy;

				}
				// if (this.kind == 0){
				// 	console.log(" aa speed: "+this.speed.dx);
				// 	console.log(" aa x: "+this.pos.x);
				// }
			},
			shoot: function(){
				this.shootInterval--;
				if (this.shootInterval < 0){
					if (this.kind == 0){
						addElem(1, this.pos.x+this.pos.width/2-2.5, this.pos.y+this.pos.height/2, 5, 5, this.speed.dx, this.speed.dy-15);
					}else{
						addElem(2, this.pos.x+this.pos.width/2-2.5, this.pos.y+this.pos.height/2, 5, 5, this.speed.dx, this.speed.dy+15);
					}
					this.shootInterval = 10;
				}
			}
		};
		elems.push(temp);
	}
	function delElem(_which) {
		elems.splice(_which, 1);
	}

</script>
</body>
</html>
